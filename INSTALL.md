# Install

## First configuration

- Download, write and launch the Debian installation `.iso` however you prefer
- Partition the main drive in such a way that `/home` has the majority of space dedicated to it:
    - 500MB EFI partition
    - 10-20GB root partition
    - rest dedicated to `/home`
- Proceed until you reach Tasksel and <ins>**o n l y**</ins> install `SSH server` and `standard system utilities`
- Finish the installation process, reboot and login as root
- Set a static IP for your server in `/etc/network/interfaces`:
    ```
    iface enp0s31f6 inet static
    address 192.168.1.10
    netmask 255.255.255.0
    gateway 192.168.1.1
    ```
- Enable root SSH login in `/etc/ssh/sshd_config` by appending `PermitRootLogin yes` and shutdown the server
- Finish plugging what you need into your server, turn it on and login via SSH as root from a client

## Docker

Install [Docker](https://docs.docker.com/engine/install/debian/#install-using-the-repository) and its dependencies

```sh
# Add Docker's official GPG key:
apt-get update
apt-get install ca-certificates curl
install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  tee /etc/apt/sources.list.d/docker.list > /dev/null
apt-get update

# Install
apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

Add a dedicated system user who will own your mounted docker volumes

```sh
# Create system user home directory
mkdir -p /srv/docker
# Add user with no login access
useradd -r -s /usr/sbin/nologin -d /srv/docker -g docker docker
# Set a password for SFTP only access
passwd docker
```

## Services

Configure each `.env` and `docker-compose.yml` file the way you want. Most of the images are from [linuxserver.io](https://www.linuxserver.io/), meaning that you'll be able to set file ownership of what's in the container volumes to an user of your choice. In my case I decided to use the system user `docker`. During its creation I set its primary group to `docker` which is a group generated by docker itself during installation. You can inspect an user UID and GID by running the command `id username`.

You install a service by navigating into their directory wiht `cd` and runnng `docker compose up -d`. To stop the entire stack of containers inside a docker-compose.yml file you can simply run `docker compose down` while inside the service directory.

## DDNS and Wireguard

DuckDNS has been my DDNS service of choice. It's main purpose is to automatically resolve a customizable URL so that it points to your main server public IP. The DuckDNS docker container will make sure to keep the domain synced to your public IP in case your ISP doesn't provide a static IP. In order to register to DuckDNS all you have to do is visit their [website](https://www.duckdns.org/), sign-in using on of the methods available, generate a subdomain of your choice and write it down along with your token which you'll be using in the `.env` file of the Wireguard's `docker-compose.yml`.

Now all you have to do is to [expose the port](https://portforward.com/wireguard/) needed by Wireguard in your router and run the container stack.

## Media sharing

### SFTP - [Documentation](https://web.archive.org/web/20241114203204/https://www.turnkeylinux.org/docs/set-up-sftp-chroot-jail)

Add an user to a dedicated SFTP group

```sh
# Add a dedicated group for SFTP access
groupadd sftpusers
# Add your main user to the sftpusers group..
usermod -aG sftpusers my-user
usermod -s /usr/sbin/nologin my-user
# ..or optionally create a new user with no login access
useradd -G sftpusers -s /usr/sbin/nologin friend-user
# and set a password for SFTP only access
passwd friend-user
```

Configure their SFTP jail

```sh
# Create the user's sftp root
mkdir -p /home/username/files
# Change ownership to root for sftp jail to work
chown root:root /home/username
# Make sure the user has access to the new root
chown username:username /home/username/files
# And that nobody but them can access to it
chmod 700 /home/username/files
# Finally set the new root as home directory
usermod -d /home/username/files username
```

Replace the following default line in `/etc/ssh/sshd_config`

```
# From this
Subsystem       sftp    /usr/lib/openssh/sftp-server
# to this
Subsystem       sftp    internal-sftp
```

Use the config files in the `ssh` directory in this repository as template

```sh
# Finally restart the SSH server to load the new configuration
systemctl restart sshd
```

### Samba - [Documentation](https://wiki.debian.org/Samba/ServerSimple)

Optionally add a samba share for easy access on Windows clients

```sh
# Create a companion samba user with the same name as your user
smbpasswd -a username
```

Append a new samba share to `/etc/samba/smb.conf`
```conf
[anameofyourchoice]
   read only = no
   path = /home/username/files
   guest ok = no
   valid user = username
```
Restart samba with `systemctl restart smbd` and access the directory with `\\server-ip\anameofyourchoice`.